trigger: none
pr: none

pool:
  name: 'Azure Pipelines'

variables:
  buildConfiguration: '$(BUILD_CONFIGURATION)'
  azureSubscription: 'store-app-azure-connection'
  appName: 'wa-store-app'

  projects: |
    API/StoreApp.BLL/StoreApp.BLL.csproj
    API/AuthenticateApp.DAL/StoreApp.DAL.csproj
    API/AuthenticateApp.API/StoreApp.API.csproj
    Shared/StoreApp.Shared/StoreApp.Shared.csproj
    Shared/StoreApp.Models/StoreApp.Models.csproj

steps:
  - task: UseDotNet@2
    displayName: 'Install .NET Core SDK'
    inputs:
      packageType: 'sdk'
      version: '9.0.x'

  - task: DotNetCoreCLI@2
    displayName: 'dotnet restore'
    inputs:
      command: 'restore'
      projects: $(projects)

  - task: DotNetCoreCLI@2
    displayName: 'dotnet build'
    inputs:
      command: 'build'
      arguments: --configuration $(buildConfiguration)
      projects: $(projects)

  - task: DotNetCoreCLI@2
    displayName: 'dotnet publish'
    inputs:
      command: 'publish'
      publishWebProjects: false
      projects: $(projects)
      arguments: '--configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)'
      zipAfterPublish: true

  - task: FileTransform@1
    displayName: 'Inject connection strings from pipeline variables'
    inputs:
      folderPath: '$(Build.ArtifactStagingDirectory)/StoreApp.API'
      fileType: 'json'
      targetFiles: '**/appsettings.json'
    env:
      ConnectionStrings__DefaultConnection: "$(SQL_CONNECTION_STRING)"
      ConnectionStrings__AzureBlobStorage: "$(AZURE_BLOB_STORAGE)"

  - task: AzureWebApp@1
    displayName: 'Deploy to Azure App Service'
    inputs:
      azureSubscription: $(azureSubscription)
      appType: 'webApp'
      appName: $(appName)
      package: '$(Build.ArtifactStagingDirectory)/StoreApp.API.zip'
